modules:
  - type: os-release
    properties:
      ID: mizukios
      ID_LIKE: fedora
      NAME: MizukiOS
      VERSION: 43 (Ribbon)
      PRETTY_NAME: MizukiOS
      DEFAULT_HOSTNAME: mizukios
      VERSION_CODENAME: Ribbon


  # install fedora logos and dnf5-plugins that is needed for copr management and other actions, most borrowed from vedaos here and below
  - type: dnf
    install:
      packages:
        - fedora-logos
        - dnf5-plugins

  # copying system files over to the system
  - type: files
    files:
      - source: system
        destination: /

  # remove leftovers from fedora-bootc
  - type: dnf
    remove:
      packages:
        - console-login-helper-messages
        - chrony
        - sssd*
        - qemu-user-static*
        - toolbox

  # delete chsh since we don't need it, create roothome dir, add fedora-multimedia
  - type: script
    snippets:
      - "rm -f /usr/bin/chsh"
      - "rm -f /usr/bin/lchsh"
      - "mkdir -p /var/roothome"
      - "dnf5 config-manager addrepo --from-repofile='https://negativo17.org/repos/fedora-multimedia.repo'"
      - "dnf5 config-manager setopt fedora-multimedia.priority=90"
      - "dnf5 config-manager setopt fedora-cisco-openh264.enabled=0"

  # enable terra repo, install packages from fedora-multimedia, install ocl-icd
  - type: script
    snippets:
      - "dnf5 -y install --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release{,-extras,-mesa}"
      - 'dnf5 -y config-manager setopt "*terra*".priority=3 "*terra*".exclude="nerd-fonts topgrade scx-tools scx-scheds steam python3-protobuf"'
      - 'dnf5 -y config-manager setopt "terra-mesa".enabled=true'

  - type: dnf
    install:
      skip-unavailable: true
      packages:
        - fdk-aac
        - intel-gmmlib
        - intel-mediasdk
        - intel-vpl-gpu-rt
        - libfdk-aac
        - libheif
        - libva
        - libva-intel-media-driver
        - mesa-dri-drivers
        - mesa-filesystem
        - mesa-libEGL
        - mesa-libGL
        - mesa-libgbm
        - mesa-va-drivers
        - mesa-vulkan-drivers
        - ocl-icd

  # install so called "batteries" coined by ublue
  - type: dnf
    repos:
      cleanup: true
      copr:
        - ublue-os/packages
        - ublue-os/staging
    install:
      packages:
        - ublue-os-udev-rules
        - fedora-repos-archive
        - zstd
        - alsa-firmware
        - apr
        - apr-util
        - distrobox
        - ffmpeg
        - ffmpeg-libs
        - ffmpegthumbnailer
        - flatpak-spawn
        - fuse
        - fzf
        - google-noto-sans-balinese-fonts
        - google-noto-sans-cjk-fonts
        - google-noto-sans-javanese-fonts
        - google-noto-sans-sundanese-fonts
        - grub2-tools-extra
        - heif-pixbuf-loader
        - intel-vaapi-driver
        - jetbrainsmono-nerd-fonts
        - just
        - libavcodec
        - libcamera
        - libcamera-gstreamer
        - libcamera-ipa
        - libheif
        - libcamera-tools
        - libimobiledevice-utils
        - libratbag-ratbagd
        - libva-utils
        - lshw
        - net-tools
        - nvme-cli
        - nvtop
        - openrgb-udev-rules
        - openssl
        - oversteer-udev
        - pam-u2f
        - pam_yubico
        - pamu2fcfg
        - pipewire-plugin-libcamera
        - powerstat
        - smartmontools
        - solaar-udev
        - squashfs-tools
        - symlinks
        - tcpdump
        - tmux
        - traceroute
        - usbmuxd
        - vim
        - wireguard-tools
        - wl-clipboard
        - xhost
        - xorg-x11-xauth
        - yubikey-manager

  # install cosign directly from github, use CoreOS' generator for emergency/rescue boot, bunch of workarounds
  - type: script
    scripts:
      - install-cosign.sh
      - fix-brew.sh # we're doing it here so it won't error out in snippets
    snippets:
      - "curl --retry 3 -sSLo /usr/lib/systemd/system-generators/coreos-sulogin-force-generator https://raw.githubusercontent.com/coreos/fedora-coreos-config/refs/heads/stable/overlay.d/05core/usr/lib/systemd/system-generators/coreos-sulogin-force-generator"
      - "chmod +x /usr/lib/systemd/system-generators/coreos-sulogin-force-generator"
      - "mv '/usr/share/doc/just/README.中文.md' '/usr/share/doc/just/README.zh-cn.md'"
      - "ln -s '/usr/share/fonts/google-noto-sans-cjk-fonts' '/usr/share/fonts/noto-cjk'"

  # swap kernel
  - type: script
    scripts:
      - swap-kernel.sh

  # install brew, updates would be handled with uupd
  - type: copy
    from: ghcr.io/ublue-os/brew:latest
    src: /system_files
    dest: /

  - type: dnf
    repos:
      cleanup: true
      copr:
        - atim/starship
    install:
      packages:
        - btop
        - chezmoi
        - fastfetch
        - fish
        - hyfetch
        - starship

    # install basic packages and niri, most borrowed from zirconium
  - type: dnf
    repos:
      cleanup: true
      copr:
        - yalter/niri-git
        - avengemedia/dms-git
        - avengemedia/danklinux
        - ulysg/xwayland-satellite
      files:
        - https://pkgs.tailscale.com/stable/fedora/tailscale.repo
    install:
      install-weak-deps: false
      packages:
        - repo: copr:copr.fedorainfracloud.org:ulysg:xwayland-satellite
          packages:
           - xwayland-satellite
        - repo: copr:copr.fedorainfracloud.org:yalter:niri-git
          packages:
           - niri
        - alsa-firmware
        - alsa-sof-firmware
        - alsa-tools-firmware
        - atheros-firmware
        - audispd-plugins
        - audit
        - brcmfmac-firmware
        - cifs-utils
        - cups
        - cups-pk-helper
        - dymo-cups-drivers
        - firewalld
        - fprintd
        - fprintd-pam
        - flatpak
        - firewalld
        - fuse
        - fuse-common
        - fwupd
        - gnome-disk-utility
        - gdm
        - git
        - glibc-all-langpacks
        - gum
        - gvfs-archive
        - gvfs-mtp
        - gvfs-nfs
        - gvfs-smb
        - hplip
        - hyperv-daemons
        - ibus
        - ifuse
        - intel-audio-firmware
        - iwlegacy-firmware
        - iwlwifi-dvm-firmware
        - iwlwifi-mvm-firmware
        - jmtpfs
        - jetbrains-mono-fonts-all
        - kernel-modules-extra
        - libcamera{,-{v4l2,gstreamer,tools}}
        - libimobiledevice
        - libimobiledevice-utils
        - libratbag-ratbagd
        - man-db
        - man-pages
        - mobile-broadband-provider-info
        - mt7xxx-firmware
        - NetworkManager
        - NetworkManager-adsl
        - NetworkManager-bluetooth
        - NetworkManager-config-connectivity-fedora
        - NetworkManager-libnm
        - NetworkManager-openconnect
        - NetworkManager-openvpn
        - NetworkManager-strongswan
        - NetworkManager-ssh
        - NetworkManager-ssh-selinux
        - NetworkManager-vpnc
        - NetworkManager-wifi
        - NetworkManager-wwan
        - nxpwireless-firmware
        - open-vm-tools
        - open-vm-tools-desktop
        - openconnect
        - pam_yubico
        - pcsc-lite
        - plymouth
        - plymouth-system-theme
        - printer-driver-brlaser
        - ptouch-driver
        - qemu-guest-agent
        - realtek-firmware
        - rsync
        - spice-vdagent
        - steam-devices
        - switcheroo-control
        - system-config-printer-libs
        - system-config-printer-udev
        - systemd-container
        - systemd-oomd-defaults
        - tiwilink-firmware
        - tuned
        - tuned-ppd
        - unzip
        - uupd
        - usb_modeswitch
        - uxplay
        - vpnc
        - whois
        - wireguard-tools
        - zram-generator-defaults
        - tailscale
        - dms # niri starts here
        - dms-cli
        - dms-greeter
        - dgop
        - fcitx5-configtool
        - fcitx5-mozc
        - fcitx5-chinese-addons
        - fcitx5-gtk
        - fcitx5-hangul
        - kcm-fcitx5
        - quickshell-git
        - wget
        - wl-clipboard

  # get new luks stuff from bluefin. gum is required which is installed on previous step
  - type: copy
    from: ghcr.io/projectbluefin/common:latest
    src: /system_files/shared/usr/bin/luks*
    dest: /us

  - type: dnf # adds qt6 things
    repos:
      cleanup: true
    install:
      install-weak-deps: false
      packages:
        - kf6-kirigami
        - qt6ct
        - polkit-kde
        - plasma-breeze
        - kf6-qqc2-desktop-style
        
  - type: dnf #packages for japanese kanji rendering instead of chinese fallback
    repos:
      cleanup: true
    install:
      install-weak-deps: false
      packages:
        - langpacks-ja
        - default-fonts-cjk-sans
        - google-noto-sans-cjk-vf-fonts
        - langpacks-core-ja
        - langpacks-fonts-ja

  # install steam
  - type: dnf
    install:
      install-weak-deps: false
      packages:
        - steam

  # give bazzite copr repos a priority, install gamescope and scb
  - type: script
    snippets:
      - "dnf5 -y copr enable bazzite-org/bazzite"
      - "dnf5 -y copr enable bazzite-org/bazzite-multilib"
      - "dnf5 -y config-manager setopt '*bazzite*'.priority=90"
      - "dnf5 -y install gamescope-libs gamescope-shaders"
      - "dnf5 -y copr disable bazzite-org/bazzite"
      - "dnf5 -y copr disable bazzite-org/bazzite-multilib"
      - "curl -Lo /usr/bin/scopebuddy https://raw.githubusercontent.com/HikariKnight/ScopeBuddy/refs/heads/main/bin/scopebuddy"
      - "chmod +x /usr/bin/scopebuddy"
      - "ln -s scopebuddy /usr/bin/scb"

  # add flathub, a way better flatpak repo, and remove fedora flatpaks
  - type: script
    snippets:
      - "mkdir -p /etc/flatpak/remotes.d/"
      - "curl --retry 3 -Lo /etc/flatpak/remotes.d/flathub.flatpakrepo https://dl.flathub.org/repo/flathub.flatpakrepo"
      - "rm -f /usr/lib/systemd/system/flatpak-add-fedora-repos.service"

  - type: chezmoi
    repository: "https://github.com/koitorin/MizukiOS-Ribbons"
    all-users: true
    file-conflict-policy: skip

  # some finishing touches
  - type: script
    snippets:
      - "sed -i 's|uupd|& --disable-module-distrobox|' /usr/lib/systemd/system/uupd.service"
      - "sed -i '/^REDHAT_BUGZILLA_PRODUCT=/d;/^REDHAT_BUGZILLA_PRODUCT_VERSION=/d;/^REDHAT_SUPPORT_PRODUCT=/d;/^REDHAT_SUPPORT_PRODUCT_VERSION=/d;/^SUPPORT_END=/d' /usr/lib/os-release"
      - "echo 'Hidden=true' >> /usr/share/applications/btop.desktop"
      - "echo 'Hidden=true' >> /usr/share/applications/nvtop.desktop"
      - "mkdir -p /usr/lib/extest"
      - "curl --retry 3 -Lo /usr/lib/extest/libextest.so https://github.com/bazzite-org/extest/releases/latest/download/libextest.so"
      - "curl --retry 3 -Lo /usr/bin/winetricks https://raw.githubusercontent.com/Winetricks/winetricks/master/src/winetricks"
      - "chmod +x /usr/bin/winetricks"
      - "sed -i 's@/usr/bin/steam@/usr/bin/mizukios-steam@g' /usr/share/applications/steam.desktop"
      - "fc-cache --force --really-force --system-only --verbose"
      - "rm -rf /usr/share/doc"
      - "rm -rf /usr/src"
      - "rpm --erase --nodeps kernel-cachyos || true"
      - "echo 'HOMEBREW_NO_ANALYTICS=1' >> /etc/environment"
      - "rm -f /tmp/ltsbuild"
      - "dnf5 versionlock clear"
      - "dnf5 clean all"

  - type: systemd
    user:
      enabled:
        - dms.service
        - cliphist.service
    system:
      enabled:
        - gdm.service
        - systemd-timesyncd.service
        - systemd-resolved.service
        - tailscaled.service
        - uupd.timer
        - flatpak-add-flathub-repos.service
        - input-remapper.service
        - rechunker-group-fix.service
        - nvctk-cdi.service
        - brew-setup.service
      disabled:
        - bootc-fetch-apply-updates.timer
        - bootc-fetch-apply-updates.service
        - akmods-keygen@akmods-keygen.service
        - akmods-keygen.target
        - rpm-ostree-countme.timer
      masked:
        - bootc-fetch-apply-updates.timer
        - bootc-fetch-apply-updates.service
        - akmods-keygen@akmods-keygen.service
        - akmods-keygen.target

  - type: default-flatpaks
    configurations:
      - notify: false # Send notification after install/uninstall is finished
        scope: system
        install:
          - app.zen_browser.zen
          - io.github.kolunmi.Bazaar

  - type: initramfs

  - type: signing
